<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>3D-Druck – Abschnitt 1</title>
  <style>
    :root{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:#f3f4f6;}
    body{margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:14px;}
    .app{background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.1);padding:18px;max-width:980px;width:100%;box-sizing:border-box;}
    h1{margin:0 0 6px;text-align:center;font-size:1.35rem;}
    .sub{margin:0 0 14px;text-align:center;color:#6b7280;font-size:.95rem}
    .pillbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin:8px 0 14px;}
    .pill{background:#eef2ff;border:1px solid #c7d2fe;padding:6px 10px;border-radius:999px;font-size:.92rem}
    .card{border:1px solid #e5e7eb;border-radius:14px;padding:14px;margin:10px 0;background:#fff;}
    .card h2{margin:0 0 8px;font-size:1.05rem}
    .small{font-size:.94rem;color:#374151;line-height:1.35}
    .hint{color:#6b7280;font-size:.92rem;margin-top:8px}
    button{border:0;background:#111827;color:#fff;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:700}
    button.secondary{background:#e5e7eb;color:#111827}
    .ok{color:#065f46;font-weight:800}
    .bad{color:#991b1b;font-weight:800}
    .mc label{display:block;border:1px solid #e5e7eb;border-radius:12px;padding:10px;margin:8px 0;cursor:pointer}
    .mc input{margin-right:8px}
    select{padding:6px 10px;border-radius:10px;border:1px solid #d1d5db;max-width:100%}
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th,td{padding:8px 10px;vertical-align:middle}
    th{font-size:.9rem;color:#6b7280;text-align:left}
    tr.row td{border:1px solid #e5e7eb}
    tr.row td:first-child{border-right:none;border-radius:10px 0 0 10px;background:#fafafa;font-weight:800;width:22%}
    tr.row td:nth-child(2){border-left:none;border-right:none;width:28%}
    tr.row td:last-child{border-left:none;border-radius:0 10px 10px 0;width:50%}
    .wordbank{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .chip{background:#f3f4f6;border:1px solid #e5e7eb;padding:6px 10px;border-radius:999px;font-size:.92rem}
    .footer{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:14px}
    .debug{margin:8px 0 0;color:#6b7280;font-size:.85rem;text-align:center}
  </style>
</head>
<body>
  <div class="app">
    <h1 id="title"></h1>
    <p class="sub" id="subtitle"></p>

    <div class="pillbar">
      <div class="pill" id="progressPill"></div>
      <div class="pill" id="detailPill"></div>
    </div>

    <div class="card">
      <h2 id="matchTitle"></h2>
      <table>
        <thead>
          <tr>
            <th>Begriff</th>
            <th>Bedeutung (kurz)</th>
            <th>Erklärung (genau)</th>
          </tr>
        </thead>
        <tbody id="matchTable"></tbody>
      </table>
      <div class="hint">Wähle zu jedem Begriff die passende Bedeutung und die passende Erklärung. Jede Option passt genau einmal.</div>
    </div>

    <div class="card">
      <h2 id="mcTitle"></h2>
      <div class="small" id="mcQuestion"></div>
      <div class="mc" id="mcWrap"></div>
    </div>

    <div class="card">
      <h2 id="clozeTitle"></h2>
      <p class="small" id="clozeText"></p>
      <div class="wordbank" id="wordbank"></div>
      <div class="hint">Wortbank: genau ein Wort passt pro Lücke. Ein Wort passt sicher nicht.</div>
    </div>

    <div class="card">
      <div class="small" id="msg"></div>
      <div class="footer">
        <button class="secondary" id="resetBtn">Zurücksetzen</button>
        <button id="checkBtn">Abschnitt prüfen</button>
      </div>
      <div class="debug" id="debug"></div>
    </div>
  </div>

<script>
const CONFIG = {
  sectionId: 1,
  title: "Abschnitt 1: Was ist 3D-Druck?",
  subtitle: "Begriff → Bedeutung → Erklärung | MC | Lückentext | Bei „gelöst“ wird AppSolved gesendet.",
  match3: {
    title: "Begriffe, Bedeutungen und Erklärungen",
    terms: ["3D","Additive Fertigung","3D-Modell","3D-Drucker"],
    meanings: [
      "dreidimensional",
      "Herstellungsart",
      "digitaler Bauplan",
      "Druckmaschine"
    ],
    explanations: [
      "Gegenstände mit Breite, Länge und Höhe",
      "Material wird schichtweise hinzugefügt",
      "Computerdatei, die die Form eines Objekts beschreibt",
      "Gerät, das ein Objekt Schicht für Schicht aufbaut"
    ],
    solutionMeaningIndex: [0,1,2,3],
    solutionExplainIndex:  [0,1,2,3]
  },
  mc: {
    title: "Multiple Choice",
    question: "Was beschreibt 3D-Druck korrekt?",
    options: [
      "Ein Objekt wird aus einem Block herausgeschnitten.",
      "Ein Objekt wird aus Einzelteilen zusammengesetzt.",
      "Ein Objekt wird Schicht für Schicht aufgebaut.",
      "Ein Objekt wird in einem Schritt hergestellt."
    ],
    correctIndex: 2
  },
  cloze: {
    title: "Lückentext",
    // 6 Lücken -> 7 Textteile
    textParts: [
      "Beim 3D-Druck entsteht ein Objekt nicht durch das ",
      ", sondern durch das ",
      ". Der Gegenstand wächst dabei ",
      " von unten nach oben. Diese Art der Herstellung nennt man ",
      " Fertigung. Damit der Drucker weiss, was er tun soll, braucht er eine ",
      " Bauanleitung aus dem Computer. Das wichtigste Element ist das digitale ",
      "."
    ],
    wordbank: ["Entfernen","Hinzufügen","schrittweise","additive","digitale","Modell","Laser"],
    solution: ["Entfernen","Hinzufügen","schrittweise","additive","digitale","Modell"]
  }
};

const $ = (id)=>document.getElementById(id);
const state = { answers:{ meaning:[], explain:[], mc:null, cloze:[] }, solved:false };

function checkAll(){
  const okMatchMeaning = CONFIG.match3.solutionMeaningIndex
    .every((sol,i)=>String(state.answers.meaning[i])===String(sol));
  const okMatchExplain = CONFIG.match3.solutionExplainIndex
    .every((sol,i)=>String(state.answers.explain[i])===String(sol));
  const okMatch = okMatchMeaning && okMatchExplain;

  const okMC = state.answers.mc === CONFIG.mc.correctIndex;

  const okCloze = CONFIG.cloze.solution.every((sol,i)=>String(state.answers.cloze[i])===String(sol));

  return {okMatch, okMC, okCloze, solved: okMatch && okMC && okCloze};
}

function updateStatus(){
  const r = checkAll();
  $("progressPill").textContent = `Status: ${r.solved ? "gelöst" : "offen"}`;
  $("detailPill").textContent = `Zuordnung: ${r.okMatch?"✓":"✗"}  MC: ${r.okMC?"✓":"✗"}  Lücken: ${r.okCloze?"✓":"✗"}`;
  $("msg").innerHTML = r.solved
    ? `<span class="ok">Gelöst ✅</span> – AppSolved wird gesendet.`
    : `<span class="bad">Noch nicht gelöst ❌</span> – bitte alles korrekt lösen.`;
  return r.solved;
}

function sendSolved(){
  try{
    window.parent?.postMessage("AppSolved","*");
    $("debug").textContent = "Debug: AppSolved gesendet (postMessage).";
  }catch(e){
    $("debug").textContent = "Debug: postMessage fehlgeschlagen.";
  }
}

function buildSelect(options, placeholder){
  const sel = document.createElement("select");
  sel.innerHTML = `<option value="">${placeholder}</option>` +
    options.map((o,i)=>`<option value="${i}">${o}</option>`).join("");
  return sel;
}

function render(){
  $("title").textContent = CONFIG.title;
  $("subtitle").textContent = CONFIG.subtitle;

  // Match3 (Begriff -> Bedeutung + Erklärung)
  $("matchTitle").textContent = CONFIG.match3.title;
  const tbody = $("matchTable");
  tbody.innerHTML = "";

  CONFIG.match3.terms.forEach((term,i)=>{
    const tr = document.createElement("tr");
    tr.className = "row";

    const tdTerm = document.createElement("td");
    tdTerm.textContent = term;

    const tdMeaning = document.createElement("td");
    const selM = buildSelect(CONFIG.match3.meanings, "– Bedeutung –");
    selM.onchange = ()=>{ state.answers.meaning[i]=selM.value; updateStatus(); };
    tdMeaning.appendChild(selM);

    const tdExplain = document.createElement("td");
    const selE = buildSelect(CONFIG.match3.explanations, "– Erklärung –");
    selE.onchange = ()=>{ state.answers.explain[i]=selE.value; updateStatus(); };
    tdExplain.appendChild(selE);

    tr.appendChild(tdTerm);
    tr.appendChild(tdMeaning);
    tr.appendChild(tdExplain);
    tbody.appendChild(tr);
  });

  // MC
  $("mcTitle").textContent = CONFIG.mc.title;
  $("mcQuestion").textContent = CONFIG.mc.question;
  const mw = $("mcWrap"); mw.innerHTML = "";
  CONFIG.mc.options.forEach((opt,idx)=>{
    const lab = document.createElement("label");
    const inp = document.createElement("input");
    inp.type="radio"; inp.name="mc"; inp.value=idx;
    inp.onchange = ()=>{ state.answers.mc = idx; updateStatus(); };
    lab.appendChild(inp);
    lab.appendChild(document.createTextNode(opt));
    mw.appendChild(lab);
  });

  // Cloze
  $("clozeTitle").textContent = CONFIG.cloze.title;
  const p = $("clozeText"); p.innerHTML = "";
  for(let i=0;i<CONFIG.cloze.solution.length;i++){
    p.appendChild(document.createTextNode(CONFIG.cloze.textParts[i]));
    const sel = document.createElement("select");
    sel.innerHTML = `<option value="">– Wort –</option>` +
      CONFIG.cloze.wordbank.map(w=>`<option value="${w}">${w}</option>`).join("");
    sel.onchange = ()=>{ state.answers.cloze[i]=sel.value; updateStatus(); };
    p.appendChild(sel);
  }
  p.appendChild(document.createTextNode(CONFIG.cloze.textParts[CONFIG.cloze.solution.length]));

  const wb = $("wordbank"); wb.innerHTML = "";
  CONFIG.cloze.wordbank.forEach(w=>{
    const c = document.createElement("span");
    c.className="chip"; c.textContent=w;
    wb.appendChild(c);
  });

  $("checkBtn").onclick = ()=>{
    const solved = updateStatus();
    if(solved) sendSolved();
  };
  $("resetBtn").onclick = ()=>location.reload();

  updateStatus();
}
render();
</script>
</body>
</html>
